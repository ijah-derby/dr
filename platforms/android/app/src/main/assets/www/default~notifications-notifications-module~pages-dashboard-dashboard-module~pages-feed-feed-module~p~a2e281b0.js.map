{"version":3,"sources":["./src/app/notifications/service/notification.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;AAAqD;AAKO;AAC4B;AAC7B;AAEa;AAKxE;IAAyC,6EAAQ;IAM/C,6BACU,gBAAkC,EAClC,QAAkB,EAClB,GAAqB,EACrB,WAAwB;QAJlC,YAME,kBAAM,QAAQ,CAAC,SAChB;QANS,sBAAgB,GAAhB,gBAAgB,CAAkB;QAClC,cAAQ,GAAR,QAAQ,CAAU;QAClB,SAAG,GAAH,GAAG,CAAkB;QACrB,iBAAW,GAAX,WAAW,CAAa;QARlC,aAAO,GAAG,IAAI,CAAC;QAER,mBAAa,GAAG,CAAC,CAAC;;IASzB,CAAC;IAEM,8CAAgB,GAAvB,UAAwB,GAAW;QAAnC,iBAiCC;QAhCC,IAAG,CAAC,GAAG,EAAE;YACP,OAAO;SACR;QACD,OAAO,IAAI,OAAO,CAAC,UAAO,OAAO,EAAE,MAAM;;;gBACvC,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAgB,eAAe,EAAE,aAAG,IAAI,UAAG,CAAC,KAAK,CAAC,IAAI,EAAE,oBAAoB,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,OAAO,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,EAAnF,CAAmF,CAAC,CAAC,SAAS,CAAC,cAAI;oBAC1K,KAAI,CAAC,aAAa,GAAG,EAAE,CAAC;oBACxB,KAAI,CAAC,aAAa,GAAG,CAAC,CAAC;oBACvB,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;oBAClB,IAAI,CAAC,OAAO,CAAC,UAAO,YAAY;;4BAE9B,IAAI,YAAY,CAAC,IAAI,KAAK,CAAC,EAAE;gCAC3B,YAAY,CAAC,MAAM,GAAG,CAAC,YAAY,CAAC,MAAM;oCACxC,CAAC,CAAC,EAAE;oCACJ,CAAC,CAAC,YAAY,CAAC,MAAM,CAAC;6BACzB;4BACD,YAAY,CAAC,SAAS,GAAG,CAAC,YAAY,CAAC,SAAS;gCAC9C,CAAC,CAAC,EAAE;gCACJ,CAAC,CAAC,YAAY,CAAC,SAAS,CAAC;4BAC3B,YAAY,CAAC,SAAS,GAAG,CAAC,YAAY,CAAC,SAAS;gCAC9C,CAAC,CAAC,IAAI;gCACN,CAAC,CAAC,YAAY,CAAC,SAAS,CAAC;4BAC3B,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;4BACtC,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;;;yBAC7B,CAAC,CAAC;oBACH,IAAG,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE;wBACpB,OAAO,CAAC,EAAE,CAAC,CAAC;qBACb;gBACH,CAAC,EAAE,aAAG;oBACJ,OAAO,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;oBACxB,MAAM,CAAC,GAAG,CAAC,CAAC;gBACd,CAAC,CAAC,CAAC;;;aACJ,CAAC,CAAC;IACL,CAAC;IAEO,sDAAwB,GAAhC,UAAiC,GAAW;QAA5C,iBAiCC;QAhCC,IAAG,CAAC,GAAG,EAAE;YACP,OAAO;SACR;QACD,OAAO,IAAI,OAAO,CAAC,UAAO,OAAO,EAAE,MAAM;;;gBACvC,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAgB,eAAe,EAAE,aAAG,IAAI,UAAG,CAAC,KAAK,CAAC,IAAI,EAAE,oBAAoB,EAAE,CAAC,GAAG,CAAC,CAAC,EAA5C,CAA4C,CAAC,CAAC,SAAS,CAAC,cAAI;oBACnI,KAAI,CAAC,aAAa,GAAG,EAAE,CAAC;oBACxB,KAAI,CAAC,aAAa,GAAG,CAAC,CAAC;oBACvB,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;oBAClB,IAAI,CAAC,OAAO,CAAC,UAAO,YAAY;;4BAE9B,IAAI,YAAY,CAAC,IAAI,KAAK,CAAC,EAAE;gCAC3B,YAAY,CAAC,MAAM,GAAG,CAAC,YAAY,CAAC,MAAM;oCACxC,CAAC,CAAC,EAAE;oCACJ,CAAC,CAAC,YAAY,CAAC,MAAM,CAAC;6BACzB;4BACD,YAAY,CAAC,SAAS,GAAG,CAAC,YAAY,CAAC,SAAS;gCAC9C,CAAC,CAAC,EAAE;gCACJ,CAAC,CAAC,YAAY,CAAC,SAAS,CAAC;4BAC3B,YAAY,CAAC,SAAS,GAAG,CAAC,YAAY,CAAC,SAAS;gCAC9C,CAAC,CAAC,IAAI;gCACN,CAAC,CAAC,YAAY,CAAC,SAAS,CAAC;4BAC3B,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;4BACtC,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;;;yBAC7B,CAAC,CAAC;oBACH,IAAG,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE;wBACpB,OAAO,CAAC,EAAE,CAAC,CAAC;qBACb;gBACH,CAAC,EAAE,aAAG;oBACJ,OAAO,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;oBACxB,MAAM,CAAC,GAAG,CAAC,CAAC;gBACd,CAAC,CAAC,CAAC;;;aACJ,CAAC,CAAC;IACL,CAAC;IAEM,4CAAc,GAArB,UAAsB,aAA8B,EAAE,GAAG;QAAzD,iBAeC;QAdC,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC;QACvB,aAAa,CAAC,OAAO,CAAC,UAAC,IAAmB;YACxC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;gBACjC,IAAI,IAAI,CAAC,IAAI,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,IAAI,IAAI,CAAC,EAAE,KAAK,GAAG,CAAC,EAAE;oBACrE,IACE,CAAC,IAAI,CAAC,IAAI,KAAK,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC;wBACpD,CAAC,IAAI,CAAC,IAAI,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,KAAK,CAAC,IAAI,IAAI,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC,EACzD;wBACA,KAAI,CAAC,aAAa,GAAG,KAAI,CAAC,aAAa,GAAG,CAAC,CAAC;qBAC7C;iBACF;aACF;QACH,CAAC,CAAC,CAAC;QACH,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B,CAAC;IAEM,kDAAoB,GAA3B,UAA4B,EAAU;QACpC,OAAO,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAQ,UAAQ,EAAI,CAAC,CAAC;IACnE,CAAC;IAGD,uCAAS,GAAT,UAAU,aAAkB,EAAE,WAAW;QAAzC,iBAsFC;QArFC,IAAI,kBAAkB,GAAG,EAAE,CAAC;QAC5B,IAAG,aAAa,CAAC,MAAM,KAAK,CAAC,EAAC;YAC5B,OAAO;SACR;QACD,OAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;YACjC,KAAI,CAAC,cAAc,CAAC,2BAA2B,CAAC,4BAA4B,CAAC,CAAC;YAC9E,KAAI,CAAC,wBAAwB,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,UAAC,IAAW;gBAC9D,OAAO,CAAC,GAAG,CAAC,uBAAuB,EAAC,IAAI,CAAC,CAAC;gBAC1C,kBAAkB,GAAG,IAAI,CAAC;gBAC1B,aAAa,GAAG,IAAI,CAAC;gBACrB,KAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;gBACpC,KAAI,CAAC,cAAc,CAAC,2BAA2B,CAAC,cAAY,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,mBAAgB,CAAC,CAAC;gBAExG,kBAAkB,CAAC,OAAO,CAAC,UAAO,IAAI,EAAE,KAAK;;;;wBAC3C,IAAI,CAAC,IAAI,CAAC,SAAS,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE;4BAChE,IAAI,IAAI,CAAC,SAAS,EAAE;gCAClB,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;6BACtC;iCAAM;gCACD,GAAG,GAAa,EAAE,CAAC;gCACvB,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;gCAC1B,IAAI,CAAC,SAAS,GAAG,GAAG,CAAC;6BACtB;4BACD,IAAI,IAAI,CAAC,IAAI,KAAK,CAAC,EAAE;gCACnB,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gCACnB,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,mBAAiB,IAAI,CAAC,EAAI,CAAC,CAAC,IAAI,CAC3D;oCACE,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,KAAK,EAAE,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,EAAE,CAAC,kBAAkB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;oCAChG,IAAI,KAAK,KAAK,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,EAAE;wCACxC,KAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;wCACpC,KAAI,CAAC,OAAO,GAAG,KAAK,CAAC;wCACrB,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;wCAChC,OAAO,CAAC,IAAI,CAAC,CAAC;qCACf;gCACH,CAAC,EACD,UAAC,GAAG,IAAK,YAAI,CAAC,cAAc,CAAC,aAAa,EAAE,EAAnC,CAAmC,CAC7C,CAAC;6BACH;iCAAM;gCACL,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gCACb,KAAK,GAAG,IAAI,CAAC,EAAE,CAAC;gCACtB,IAAG,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,EAAE;oCACtC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;iCACjD;gCACD,IAAI,CAAC,gBAAgB;qCACpB,MAAM,CAAC,mBAAiB,IAAI,CAAC,EAAI,EAAE,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC;qCACjD,IAAI,CACH;oCACE,IAAI,KAAK,KAAK,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,EAAE;wCACxC,KAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;wCACpC,KAAI,CAAC,OAAO,GAAG,KAAK,CAAC;wCACrB,OAAO,CAAC,IAAI,CAAC,CAAC;qCACf;gCACH,CAAC,EACD,UAAC,GAAG;oCACF,KAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;oCACpC,KAAI,CAAC,KAAK,CAAC,+BAA+B,CAAC,CAAC;oCAC5C,MAAM,CAAC,KAAK,CAAC,CAAC;gCAChB,CAAC,CACF,CAAC;6BACH;yBACF;6BAAM;4BACL,OAAO,CAAC,GAAG,CAAC,qBAAqB,CAAC,CAAC;4BAC7B,KAAK,GAAG,IAAI,CAAC,EAAE,CAAC;4BACpB,IAAG,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,EAAE;gCACtC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;6BACjD;4BACD,IAAI,CAAC,gBAAgB;iCACpB,MAAM,CAAC,mBAAiB,IAAI,CAAC,EAAI,EAAE,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC;iCACjD,IAAI,CACH;gCACE,IAAI,KAAK,KAAK,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,EAAE;oCACxC,KAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;oCACpC,KAAI,CAAC,OAAO,GAAG,KAAK,CAAC;oCACrB,OAAO,CAAC,IAAI,CAAC,CAAC;iCACf;4BACH,CAAC,EACD,UAAC,GAAG;gCACF,KAAI,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;gCACpC,KAAI,CAAC,KAAK,CAAC,+BAA+B,CAAC,CAAC;gCAC5C,MAAM,CAAC,KAAK,CAAC,CAAC;4BAChB,CAAC,CACF,CAAC;yBACL;;;qBACF,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;;gBA1L2B,6FAAgB;gBACxB,sDAAQ;gBACb,wEAAgB;gBACR,qFAAW;;IAVvB,mBAAmB;QAH/B,gEAAU,CAAC;YACV,UAAU,EAAE,MAAM;SACnB,CAAC;+EAQ4B,6FAAgB;YACxB,sDAAQ;YACb,wEAAgB;YACR,qFAAW;OAVvB,mBAAmB,CAoM/B;IAAD,0BAAC;CAAA,CApMwC,iEAAQ,GAoMhD;AApM+B","file":"default~notifications-notifications-module~pages-dashboard-dashboard-module~pages-feed-feed-module~p~a2e281b0.js","sourcesContent":["import { Injectable, Injector } from \"@angular/core\";\r\nimport { BehaviorSubject, combineLatest, Observable } from \"rxjs\";\r\nimport { map, switchMap } from \"rxjs/operators\";\r\nimport { IFeed } from \"../../../pages/feed/models/feed\";\r\nimport { INotification } from \"../../../pages/messages/models/message\";\r\nimport { Extender } from \"../../../shared/helpers/extender\";\r\nimport { FirestoreService } from \"../../../shared/services/firestore/firestore.service\";\r\nimport { AngularFirestore } from \"@angular/fire/firestore\";\r\nimport { resolve } from \"url\";\r\nimport { AuthService } from \"src/pages/auth/services/auth/auth.service\";\r\n\r\n@Injectable({\r\n  providedIn: \"root\",\r\n})\r\nexport class NotificationService extends Extender {\r\n\r\n  isFound = true;\r\n  public notifications: INotification[];\r\n  public unreadCounter = 0;\r\n\r\n  constructor(\r\n    private firestoreService: FirestoreService,\r\n    private injector: Injector,\r\n    private afs: AngularFirestore,\r\n    private authService: AuthService\r\n  ) {\r\n    super(injector);\r\n  }\r\n\r\n  public getNotifications(uid: string) {\r\n    if(!uid) {\r\n      return;\r\n    }\r\n    return new Promise(async (resolve, reject) => {\r\n      this.firestoreService.colWithIds$<INotification>(\"notifications\", ref => ref.where('to', 'array-contains-any', [uid]).orderBy(\"timestamp\", \"desc\").limit(10)).subscribe(resp => {\r\n        this.notifications = [];\r\n        this.unreadCounter = 0;\r\n        console.log(resp);\r\n        resp.forEach(async (notification) => {\r\n\r\n          if (notification.type === 1) {\r\n            notification.seenBy = !notification.seenBy\r\n              ? []\r\n              : notification.seenBy;\r\n          }\r\n          notification.deletedBy = !notification.deletedBy\r\n            ? []\r\n            : notification.deletedBy;\r\n          notification.postPhoto = !notification.postPhoto\r\n            ? null\r\n            : notification.postPhoto;\r\n          this.notifications.push(notification);\r\n          resolve(this.notifications);\r\n        });\r\n        if(resp.length === 0) {\r\n          resolve([]);\r\n        }\r\n      }, err => {\r\n        console.log('err', err);\r\n        reject(err);\r\n      });\r\n    });\r\n  }\r\n\r\n  private loadNotificationsPromise(uid: string) {\r\n    if(!uid) {\r\n      return;\r\n    }\r\n    return new Promise(async (resolve, reject) => {\r\n      this.firestoreService.colWithIds$<INotification>(\"notifications\", ref => ref.where('to', 'array-contains-any', [uid])).subscribe(resp => {\r\n        this.notifications = [];\r\n        this.unreadCounter = 0;\r\n        console.log(resp);\r\n        resp.forEach(async (notification) => {\r\n\r\n          if (notification.type === 1) {\r\n            notification.seenBy = !notification.seenBy\r\n              ? []\r\n              : notification.seenBy;\r\n          }\r\n          notification.deletedBy = !notification.deletedBy\r\n            ? []\r\n            : notification.deletedBy;\r\n          notification.postPhoto = !notification.postPhoto\r\n            ? null\r\n            : notification.postPhoto;\r\n          this.notifications.push(notification);\r\n          resolve(this.notifications);\r\n        });\r\n        if(resp.length === 0) {\r\n          resolve([]);\r\n        }\r\n      }, err => {\r\n        console.log('err', err);\r\n        reject(err);\r\n      });\r\n    });\r\n  }\r\n\r\n  public getUnreadCount(notifications: INotification[], uid) {\r\n    this.unreadCounter = 0;\r\n    notifications.forEach((item: INotification) => {\r\n      if (!item.deletedBy.includes(uid)) {\r\n        if (item.type === 1 || (item.to.indexOf(uid) > -1 && item.by !== uid)) {\r\n          if (\r\n            (item.type === 1 && item.seenBy.indexOf(uid) === -1) ||\r\n            (item.type !== 1 && (item.seen === 0 || item.seen === 2))\r\n          ) {\r\n            this.unreadCounter = this.unreadCounter + 1;\r\n          }\r\n        }\r\n      }\r\n    });\r\n    return this.unreadCounter;\r\n  }\r\n\r\n  public getUpdateSpecificDoc(id: string): Observable<IFeed> {\r\n    return this.firestoreService.getSpecificDoc<IFeed>(`feed/${id}`);\r\n  }\r\n\r\n\r\n  deleteAll(notifications: any, currentUser) {\r\n    let notificationsFound = [];\r\n    if(notifications.length === 0){\r\n      return;\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n      this.loadingService.presentProcessingLoadingMsg(`Fetching Notifications....`);\r\n      this.loadNotificationsPromise(currentUser.uid).then((resp: any[]) => {\r\n        console.log('fetched notifications',resp);\r\n        notificationsFound = resp;\r\n        notifications = resp;\r\n        this.loadingService.dismissLoader();\r\n        this.loadingService.presentProcessingLoadingMsg(`Deleting ${(notifications.length - 1)} notifications`);\r\n  \r\n        notificationsFound.forEach(async (item, index) => {\r\n          if (!item.deletedBy || !item.deletedBy.includes(currentUser.uid)) {\r\n            if (item.deletedBy) {\r\n              item.deletedBy.push(currentUser.uid);\r\n            } else {\r\n              let arr: string[] = [];\r\n              arr.push(currentUser.uid);\r\n              item.deletedBy = arr;\r\n            }\r\n            if (item.type !== 1) {\r\n              console.log(\"!=1\");\r\n              this.firestoreService.delete(`notifications/${item.id}`).then(\r\n                () => {\r\n                  console.log('deleted != 1', index, (notifications.length - 1), (notificationsFound.length - 1));\r\n                  if (index === (notifications.length - 1)) {\r\n                    this.loadingService.dismissLoader();\r\n                    this.isFound = false;\r\n                    console.log(\"completed delete\");\r\n                    resolve(true);\r\n                  }\r\n                },\r\n                (err) => this.loadingService.dismissLoader()\r\n              );\r\n            } else {\r\n              console.log(\"==1\");\r\n              const toArr = item.to;\r\n              if(toArr.indexOf(currentUser.uid) > -1) {\r\n                toArr.splice(toArr.indexOf(currentUser.uid), 1);\r\n              }\r\n              this.firestoreService\r\n              .update(`notifications/${item.id}`, { to: toArr })\r\n              .then(\r\n                () => {\r\n                  if (index === (notifications.length - 1)) {\r\n                    this.loadingService.dismissLoader();\r\n                    this.isFound = false;\r\n                    resolve(true);\r\n                  }\r\n                },\r\n                (err) => {\r\n                  this.loadingService.dismissLoader();\r\n                  this.toast(\"Error Occurred while deleting\");\r\n                  reject(false);\r\n                }\r\n              );\r\n            }\r\n          } else {\r\n            console.log('not deletedBy found');\r\n            const toArr = item.to;\r\n              if(toArr.indexOf(currentUser.uid) > -1) {\r\n                toArr.splice(toArr.indexOf(currentUser.uid), 1);\r\n              }\r\n              this.firestoreService\r\n              .update(`notifications/${item.id}`, { to: toArr })\r\n              .then(\r\n                () => {\r\n                  if (index === (notifications.length - 1)) {\r\n                    this.loadingService.dismissLoader();\r\n                    this.isFound = false;\r\n                    resolve(true);\r\n                  }\r\n                },\r\n                (err) => {\r\n                  this.loadingService.dismissLoader();\r\n                  this.toast(\"Error Occurred while deleting\");\r\n                  reject(false);\r\n                }\r\n              );\r\n          }\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n\r\n}\r\n"],"sourceRoot":"webpack:///"}